CMAKE_MINIMUM_REQUIRED(VERSION 2.8.11)

FUNCTION(PRINT_VAR  VAR_NAME)
  MESSAGE("${VAR_NAME} = '${${VAR_NAME}}'")
ENDFUNCTION()

PRINT_VAR(CMAKE_MODULE_PATH)
PRINT_VAR(USE_XSDK_DEFAULTS)
PRINT_VAR(XSDK_USE_COMPILER_ENV_VARS)

INCLUDE("CMakeForceCompiler")

PROJECT(MY_PROJ NONE)

MESSAGE("")
MESSAGE("Before XSDK: CMAKE_CXX_COMPILER = '${CMAKE_CXX_COMPILER}'")
MESSAGE("Before XSDK: CMAKE_CXX_FLAGS = '${CMAKE_CXX_FLAGS}'")
MESSAGE("Before XSDK: CMAKE_CXX_FLAGS_DEBUG = '${CMAKE_CXX_FLAGS_DEBUG}'")
MESSAGE("Before XSDK: CMAKE_CXX_FLAGS_RELEASE = '${CMAKE_CXX_FLAGS_RELEASE}'")
MESSAGE("Before XSDK: BUILD_SHARED_LIBS = '${BUILD_SHARED_LIBS}'")
MESSAGE("Before XSDK: CMAKE_BUILD_TYPE = '${CMAKE_BUILD_TYPE}'")


# A) Determine if to set compiler defaults from env var.

SET(USE_XSDK_DEFAULTS  OFF  CACHE  BOOL
  "Use XSDK defaults and behavior.")

SET(XSDK_USE_COMPILER_ENV_VARS  OFF  CACHE  BOOL
  "When in XSDK mode, read defaults for compilers and flags from env.")

SET(GET_COMPILER_DEFAULTS_FROM_ENV  TRUE)
IF (USE_XSDK_DEFAULTS  AND  NOT  XSDK_USE_COMPILER_ENV_VARS)
  SET(GET_COMPILER_DEFAULTS_FROM_ENV  FALSE)
ENDIF()

# B) Set defaults from env vars if asked and otherwise ignore the env vars
# (which goes against default CMake behavior),

IF (GET_COMPILER_DEFAULTS_FROM_ENV)
  IF (NOT "$ENV{CXX}" STREQUAL "" AND "${CMAKE_CXX_COMPILER}" STREQUAL "")
    MESSAGE("Setting CMAKE_CXX_COMPILER from env var CXX='$ENV{CXX}'!")
    SET(CMAKE_CXX_COMPILER "$ENV{CXX}" CACHE FILEPATH "Set from env var CXX")
  ENDIF()
ELSE()
  IF (NOT "$ENV{CXX}" STREQUAL "" AND "${CMAKE_CXX_COMPILER}" STREQUAL "")
    MESSAGE("NOT setting CMAKE_CXX_COMPILER from env var CXX='$ENV{CXX}'!")
    # Got to find the default C++ compiler so ENABLE_LANGAUGE(CXX) does not
    # pick up the CXX set in the env!  No way to avoid this that I can see.
    FIND_PROGRAM(DEFAULT_CXX_COMPILER  NAMES  c++  g++)
    SET(CMAKE_CXX_COMPILER "${DEFAULT_CXX_COMPILER}" CACHE FILEPATH
      "Ignoring default set by env var CXX")
  ENDIF()
ENDIF()

# C) Set defaults for other varaibles

IF (USE_XSDK_DEFAULTS)

  IF ("${BUILD_SHARED_LIBS}"  STREQUAL  "")
    MESSAGE("Setting defalt for BUILD_SHARED_LIBS to TRUE!")
    SET(BUILD_SHARED_LIBS  TRUE  CACHE  BOOL
      "Set by default in XSDK mode")
  ENDIF()

  IF ("${CMAKE_BUILD_TYPE}"  STREQUAL  "")
    MESSAGE("Setting defalt for CMAKE_BUILD_TYPE to DEBUG!")
    SET(CMAKE_BUILD_TYPE  DEBUG  CACHE  STRING
      "Set by default in XSDK mode")
  ENDIF()

ENDIF()


MESSAGE("")
MESSAGE("Before EL: CMAKE_CXX_COMPILER = '${CMAKE_CXX_COMPILER}'")
MESSAGE("Before EL: CMAKE_CXX_FLAGS = '${CMAKE_CXX_FLAGS}'")
MESSAGE("Before EL: CMAKE_CXX_FLAGS_DEBUG = '${CMAKE_CXX_FLAGS_DEBUG}'")
MESSAGE("Before EL: CMAKE_CXX_FLAGS_RELEASE = '${CMAKE_CXX_FLAGS_RELEASE}'")
MESSAGE("Before EL: BUILD_SHARED_LIBS = '${BUILD_SHARED_LIBS}'")
MESSAGE("Before EL: CMAKE_BUILD_TYPE = '${CMAKE_BUILD_TYPE}'")


IF (CMAKE_CXX_COMPILER STREQUAL "CMAKE_CXX_COMPILER_HAS_NOT_BEEN_SET")
  MESSAGE(FATAL_ERROR "CMAKE_CXX_COMPILER is not set by the user, aborting!")
ELSEIF(CMAKE_CXX_COMPILER STREQUAL "")
  MESSAGE(FATAL_ERROR "CMAKE_CXX_COMPILER was set by user to empty '', aborting!")
ENDIF()


MESSAGE("\n*** Call ENABLE_LANGUAGE(CXX) ...\n")
ENABLE_LANGUAGE(CXX)


MESSAGE("")
MESSAGE("After EL: CMAKE_CXX_COMPILER = '${CMAKE_CXX_COMPILER}'")
MESSAGE("After EL: CMAKE_CXX_FLAGS = '${CMAKE_CXX_FLAGS}'")
MESSAGE("After EL: CMAKE_CXX_FLAGS_DEBUG = '${CMAKE_CXX_FLAGS_DEBUG}'")
MESSAGE("After EL: CMAKE_CXX_FLAGS_RELEASE = '${CMAKE_CXX_FLAGS_RELEASE}'")
MESSAGE("After EL: BUILD_SHARED_LIBS = '${BUILD_SHARED_LIBS}'")
MESSAGE("After EL: CMAKE_BUILD_TYPE = '${CMAKE_BUILD_TYPE}'")
MESSAGE("After EL: CMAKE_CXX_COMPILER_ID = '${CMAKE_CXX_COMPILER_ID}'")
